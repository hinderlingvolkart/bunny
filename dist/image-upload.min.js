
var ImageUploadConfig = {

  tagName: 'imageupload',

  attrQuality: 'quality',
  defaultQuality: 0.7,
  attrOutputSize: 'outputsize',
  defaultOutputSize: '300',
  attrFormat: 'format',
  defaultFormat: 'png'

};

var ImageUpload = {

  Config: ImageUploadConfig,

  init: function init(imgupl) {
    var img = this.getImagePreview(imgupl);
    img._src = img.src;
    this.addEvents(imgupl);
  },
  initAll: function initAll() {
    var _this = this;

    var container = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : document;

    [].forEach.call(this.getAll(container), function (imgupl) {
      _this.init(imgupl);
    });
  },
  addEvents: function addEvents(imgupl) {
    var _this2 = this;

    var input = this.getFileInput(imgupl);
    var modal = this.getModal(imgupl);
    var processor = this.getImageProcessor(imgupl);
    var img = this.getImagePreview(imgupl);

    input.addEventListener('change', function (e) {
      if (modal !== false) {
        Modal.show(modal);
      } else {
        // instant image processing with auto crop/resize
        _this2.setImage(imgupl, input.files[0]);
      }
    });

    img.addEventListener('click', function () {
      input.click();
    });
    img.addEventListener('keypress', function (e) {
      if (e.keyCode === KEY_ENTER) {
        input.click();
      }
    });

    if (modal !== false) {
      Modal.onShow(modal, function () {
        ImageProcessor.setOutputSize(processor, _this2.getOutputSize(imgupl));
        ImageProcessor.setQuality(processor, _this2.getQuality(imgupl));
        ImageProcessor.init(processor, input.files[0], function (src) {
          Modal.hide(modal);
          img.src = src;
          input._file = BunnyFile.base64ToBlob(src);
        });
      });

      Modal.onHide(modal, function () {
        ImageProcessor.deinit(processor);
      });
    }

    // if reset button clicked or form.reset() called from JS - clear custom logic also
    input.form.addEventListener('reset', function (e) {
      img.src = img._src; // restore to default image
      delete input._file;
    });

    if (input.files.length > 0) {
      // after refresh photo is still in the input
      this.setImage(imgupl, input.files[0]);
    }
  },
  getQuality: function getQuality(imgupl) {
    var q = imgupl.getAttribute(this.Config.attrQuality);
    if (q) {
      q = parseFloat(q);
    } else {
      q = this.Config.defaultQuality;
    }
    return q;
  },
  getOutputSize: function getOutputSize(imgupl) {
    var s = imgupl.getAttribute(this.Config.attrOutputSize);
    if (s) {
      s = parseFloat(s);
    } else {
      s = this.Config.defaultOutputSize;
    }
    return s;
  },
  getFormat: function getFormat(imgupl) {
    var s = imgupl.getAttribute(this.Config.attrFormat);
    if (!s) {
      s = this.Config.defaultFormat;
    }
    return s;
  },
  getAll: function getAll() {
    var container = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : document;

    return container.getElementsByTagName(this.Config.tagName);
  },
  getFileInput: function getFileInput(imgupl) {
    return imgupl.getElementsByTagName('input')[0] || false;
  },
  getImagePreview: function getImagePreview(imgupl) {
    return imgupl.getElementsByTagName('img')[0] || false;
  },
  getModal: function getModal(imgupl) {
    return Modal.UI.getAll(imgupl)[0] || false;
  },
  getImageProcessor: function getImageProcessor(imgupl) {
    return ImageProcessor.UI.getAll(imgupl)[0] || false;
  },


  /**
   * Force, instant custom image set into file input._file property
   * by a base64, URL or Blob
   *
   * @param imgupl
   * @param {String|Blob} src
   */
  setImage: function setImage(imgupl, src) {
    var input = this.getFileInput(imgupl);
    var img = this.getImagePreview(imgupl);
    var size = this.getOutputSize(imgupl);
    var quality = this.getQuality(imgupl);
    var format = this.getFormat(imgupl);

    BunnyImage.getImage(src).then(function (img) {
      var canv = BunnyImage.resizeImage(img, size, size);
      return canv.toDataURL('image/' + format, quality);
    }).then(function (base64) {
      img.src = base64;
      input._file = BunnyFile.base64ToBlob(base64);
      return base64;
    });
  }
};

document.addEventListener('DOMContentLoaded', function () {
  ImageUpload.initAll();
});

